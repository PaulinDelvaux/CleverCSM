@using Microsoft.AspNet.Identity
@{
    ViewBag.Title = "Home";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<input id="gettheusername" type="hidden" value="@User.Identity.Name" />
<div class="col-md-12 clearfix" style="border-bottom:2px #ccc solid">
    <div>
        <div class="col-md-10">
            <h2>CleverCSM</h2>
        </div>
        <div id="createCompany" class="col-md-2 text-right btn btn-success" style="margin-top:15pt;display:none">
            Create Company
        </div>
    </div>
</div>
<br />
<div class="col-md-12" style="margin-top:5pt">
    <div class="col-md-6">
        <div class="col-md-6" id="allCust" style="display:block">
            <table id="Customers" class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th>Customers</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button id="createCustomer" style="width:100%;display:none" class="btn btn-success">Create Customer</button>
        </div>
        <div class="col-md-6" id="allConts" style="display:none">
            <table id="Contacts" class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th>Contacts</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="createContact" class="btn btn-success">Create Contact</div>
        </div>
    </div>
    <div class="col-md-6">
        <div id="contactInfomation" style="height: 500pt;border:#ccc 1px solid;display:none">
            <h2 id="conName" style="text-align:center">Contact Name</h2>
            <h5 id="responsibleUser" style="text-align:center;display:none"></h5>
            <br />
            <div class="col-md-12 clearfix">
                <div class="col-md-2">
                    <h5 style="font-weight:200">Company:</h5> 
                    <h5 style="font-weight:200">Email:</h5>
                    <h5 style="font-weight:200">Phone:</h5>
                    <h5 style="font-weight:200">Address:</h5>
                </div>
                <div class="col-md-4">
                    <h5 id="conCom" style="font-weight:700">Company name</h5>
                    <h5 id="conMail" style="font-weight:700">Contact Email</h5>
                    <h5 id="conPhone" style="font-weight:700">Contact Phone</h5>
                    <h5 id="conAddr" style="font-weight:700">Contact Address</h5>
                </div>
                <div class="col-lg-3 text-right">
                    <div style="width:65pt;margin-left:20pt">
                        <h5 id="conNextAtt"  style="font-weight:700">18/11/2017</h5>
                        <h5 id="conLastAtt" style="font-weight:700">4/11/2017</h5>
                        <h5 id="conNextTry" style="font-weight:700">18/11/2017</h5>
                        <h5 id="conLastTry" style="font-weight:700">4/11/2017</h5>
                    </div>
                </div>
                <div class="col-md-3 text-left">
                    <h5 style="font-weight:200">:Next Contact</h5>
                    <h5 style="font-weight:200">:Last Contact</h5>
                    <h5 style="font-weight:200">:Next Attempt</h5>
                    <h5 style="font-weight:200">:Last Attempt</h5>
                </div>
            </div>
            <br/><br/>
            <div class="col-md-12 clearfix">
                <div>
                    <div id="MailBtn" class="col-md-3 btn btn-primary">
                        Send Mail
                    </div>
                    <div class="col-md-6">
                    </div>
                    <div id="PhoneBtn" class="col-md-3 text-right btn btn-warning">
                        Phoned Contact
                    </div>
                </div>
            </div>
            <div id="phoneDiv" class="col-md-12 clearfix" style="display:none">
                <div style="text-align:center"><h3>Was the it successful?</h3></div>
                <div class="col-md-3"></div>
                <div id="yesBtn" class="col-md-3 text-right btn btn-success">
                    Yes
                </div>
                <div id="noBtn" class="col-md-3 text-right btn btn-danger">
                    No
                </div>
                <div class="col-md-3"></div>
            </div>
            <div id="mailDiv" class="col-md-12 clearfix" style="display:none">
                <div style="margin-top:20pt">
                    <input id="MailHeader" placeholder="Header" /><br/>
                    <textarea id="MailBody" style="margin-top:10pt;width:100%;max-width:100%;height:200pt" placeholder="Content"></textarea>
                </div>
                <div id="sendMailBtn" class="col-md-3 text-right btn btn-success">
                    Send Mail
                </div>
            </div>
        </div>
        <div id="createInformation" style="height: 500pt;border:#ccc 1px solid;display:none">
            <h2 id="createTypeName" style="text-align:center"></h2>
            <br />
            <div id="creatingCustomer" style="padding-left:20pt;display:none">
                <span id="creatingCustomerNameError" style="color:red"></span>
                <input id="CustomerName" type="text" class="form-control" placeholder="Name" /><br />
                <span id="creatingCustomerMailError" style="color:red"></span>
                <input id="CustomerEmail" type="email" class="form-control" placeholder="Email" /><br />
                <span id="creatingCustomerAddressError" style="color:red"></span>
                <input id="CustomerAddress" type="text" class="form-control" placeholder="Address" /><br />
                <span id="creatingCustomerPhoneError" style="color:red"></span>
                <input id="CustomerPhone" type="tel" class="form-control" placeholder="Phone" /><br />
                <div id="createCustomerBtn" class="text-right btn btn-primary" style="width:100pt">
                    Create
                </div>
            </div>
            <div id="creatingCompany" style="padding-left:20pt;display:none">
                <span id="creatingCompanyNameError" style="color:red"></span>
                <input id="CompanyName" type="text" class="form-control" placeholder="Name" /><br />
                <span id="creatingCompanyMailError" style="color:red"></span>
                <input id="CompanyEmail" type="email" class="form-control" placeholder="Email" /><br />
                <span id="creatingCompanyAddressError" style="color:red"></span>
                <input id="CompanyAddress" type="text" class="form-control" placeholder="Address" /><br />
                <span id="creatingCompanyPhoneError" style="color:red"></span>
                <input id="CompanyPhone" type="tel" class="form-control" placeholder="Phone" /><br />
                <div id="createCompanyBtn" class="text-right btn btn-primary" style="width:100pt">
                    Create
                </div>
            </div>
            <div id="creatingContact" style="padding-left:20pt;display:none">
                <span id="creatingContactNameError" style="color:red"></span>
                <input id="ContactName" type="text" class="form-control" placeholder="Name" /><br />
                <span id="creatingContactMailError" style="color:red"></span>
                <input id="ContactEmail" type="email" class="form-control" placeholder="Email" /><br />
                <span id="creatingContactAddressError" style="color:red"></span>
                <input id="ContactAddress" type="text" class="form-control" placeholder="Address" /><br />
                <span id="creatingContactPhoneError" style="color:red"></span>
                <input id="ContactPhone" type="tel" class="form-control" placeholder="Phone" /><br />
                <span id="creatingContactFrequencyError" style="color:red"></span>
                <input id="ContactFreqeuncy" type="number" class="form-control" min="1" max="365" placeholder="Contact frequency in days" /><br />
                <div id="createContactBtn" class="text-right btn btn-primary" style="width:100pt">
                    Create
                </div>
            </div>
        </div>
    </div>
</div>
<h2 id="cUserName"></h2>

@section scripts{
    <script>
        $(document).ready(function () {
            var currentUser = {
                email: document.getElementById("gettheusername").value
            };

            var currentCustomer = 0;

            var loginsurl;

            var newExchange = [];

            $.ajax({
                url: "api/users",
                dataSrc: "",
                success: function (data, type, user) {
                    for (var q = 0; q < data.length; q++) {
                        if (data[q].addressInfoEmail == currentUser.email) {
                            document.getElementById("viewUserName").innerHTML = "Hello " + data[q].name + "!";
                            currentUser = data[q];
                            loginsurl = "api/logins/" + currentUser.id;
                        }
                    }
                    $.ajax({
                        url: loginsurl,
                        dataSrc: "",
                        success: function (data, type, user) {
                            currentScope = data;
                            $("#Customers").DataTable({
                                ajax: {
                                    url: "api/customers",
                                    dataSrc: function (customer) {
                                        var rows = [];
                                        for (var t = 0; t < customer.length; t++) {
                                            for (var w = 0; w < currentScope.companyCustomer.length; w++) {
                                                if (currentScope.companyCustomer[w].customerId == customer[t].id) {
                                                    rows.push(customer[t]);
                                                }
                                            }

                                        }
                                        return rows;
                                    }
                                },
                                columns: [
                                    {
                                        data: "name",
                                        render: function (data, type, customer) {
                                            //for (var w = 0; w < currentScope.companyCustomer.length; w++) {
                                            //if (currentScope.companyCustomer[w].customerId == customer.id)
                                            return "<span class='js-cust' data-customer-id=" + customer.id + ">" + customer.name + "</span>";
                                            //}

                                        }
                                    }
                                ],
                            })
                            document.getElementById("sidebar").style.display = 'block';
                            var needContact = 0;
                            for (var q = 0; q < currentScope.exchange.length; q++) {
                                var trydate = Date.parse(currentScope.exchange[q].nextContact);
                                if (Date.now() > trydate) {
                                    var theDiv = document.getElementById('sidebarclass');
                                    var span = document.createElement('span');
                                    span.style.fontWeight = '900';
                                    var span2 = document.createElement('span');
                                    span2.style.fontWeight = '900';
                                    span.appendChild(document.createTextNode("Contact: "));

                                    theDiv.appendChild(span);
                                    theDiv.appendChild(document.createTextNode(currentScope.exchange[q].contact.name));
                                    theDiv.appendChild(document.createElement('br'));
                                    span2.appendChild(document.createTextNode("Company: "));
                                    theDiv.appendChild(span2);
                                    theDiv.appendChild(document.createTextNode(currentScope.exchange[q].contact.customer.name));
                                    if (currentUser.type == 0 && currentScope.exchange[q].user.id != currentUser.id) {
                                        theDiv.appendChild(document.createElement('br'));
                                        var span3 = document.createElement('span');
                                        span3.style.fontWeight = '900';
                                        span3.appendChild(document.createTextNode("User: "));
                                        theDiv.appendChild(span3);
                                        theDiv.appendChild(document.createTextNode(currentScope.exchange[q].user.name));
                                    }
                                    theDiv.appendChild(document.createElement('br'));
                                    theDiv.appendChild(document.createElement('br'));


                                    needContact++;
                                }
                            }
                            if (needContact == 0) {
                                var theDiv = document.getElementById('sidebarclass');
                                var span = document.createElement('span');
                                span.style.fontWeight = '900';
                                span.appendChild(document.createTextNode("No one. Good job!"));
                                theDiv.appendChild(span);
                            }

                            document.getElementById("Customers_info").style.display = 'none';
                            document.getElementById("Customers_paginate").style.display = 'none';
                            document.getElementById("Customers_length").style.display = 'none';

                            if (currentUser.type < 2)
                                document.getElementById("createCustomer").style.display = 'block';

                            if (currentUser.type==0)
                                document.getElementById("createCompany").style.display = 'block';

                        }
                    });
                }
            });


            $("#Customers").on("click", ".js-cust", function () {
                $('#Contacts tbody').empty();

                document.getElementById("createInformation").style.display = 'none';

                currentCustomer = this.getAttribute("data-customer-id");
                console.log("CurrentCustomer: " + currentCustomer);
                document.getElementById("allConts").style.display = 'block';
                document.getElementById("contactInfomation").style.display = 'none';
                $("#Contacts").DataTable({
                    destroy: true,
                    ajax: {
                        url: "api/contacts",
                        dataSrc: function (contact) {
                            var rows = [];
                            if (currentUser.type == 2) {
                                for (var q = 0; q < contact.length; q++) {
                                    for (var t = 0; t < currentScope.exchange.length; t++) {
                                        if (currentScope.exchange[t].userId == currentUser.id && currentScope.exchange[t].contactId == contact[q].id && contact[q].customerId == currentCustomer) {
                                            rows.push(contact[q]);
                                        }
                                    }
                                }
                            }
                            if (currentUser.type < 2) {
                                for (var q = 0; q < contact.length; q++) {
                                    for (var t = 0; t < currentScope.companyCustomer.length; t++) {
                                        if (currentScope.companyCustomer[t].customerId == currentCustomer && contact[q].customerId == currentCustomer) {
                                            rows.push(contact[q]);
                                        }
                                    }
                                }
                            }
                            return rows;
                        }
                    },
                    columns: [
                        {
                            data: "name",
                            render: function (data, type, contact) {
                                return "<span class='js-cont' data-contact-id=" + contact.id + ">" + contact.name + "</span>";
                            }
                        }
                    ],
                });
                document.getElementById("Contacts_info").style.display = 'none';
                document.getElementById("Contacts_paginate").style.display = 'none';
                document.getElementById("Contacts_length").style.display = 'none';
                document.getElementById("createContact").style.display = 'block';
            });

            $("#Contacts").on("click", ".js-cont", function () {
                var contact = this.getAttribute("data-contact-id");
                var contactName;

                document.getElementById("createInformation").style.display = 'none';

                $.ajax({
                    url: "api/contacts/" + contact,
                    dataSrc: "",
                    success: function (data, type, user) {
                        currentContact = data;
                        contactName = data.name;
                        document.getElementById("conName").innerHTML = contactName;
                        for (var t = 0; t < currentScope.exchange.length; t++) {
                            if ((currentScope.exchange[t].userId == currentUser.id && currentScope.exchange[t].contactId == contact) || (currentUser.type < 2 && currentScope.exchange[t].contactId == contact)) {

                                document.getElementById("responsibleUser").style.display = 'none';
                                if (currentUser.type < 2) {
                                    document.getElementById("responsibleUser").innerHTML = currentScope.exchange[t].user.name;
                                    document.getElementById("responsibleUser").style.display = 'block';
                                }
                                newExchange = currentScope.exchange[t];
                                var nextcontact = currentScope.exchange[t].nextContact.toString();
                                var nextcontactyear = nextcontact.substring(0, 4); var nextcontactmonth = nextcontact.substring(5, 7); var nextcontactday = nextcontact.substring(8, 10);

                                var trydate = Date.parse(currentScope.exchange[t].nextContact);
                                var attemptdate = Date.parse(currentScope.exchange[t].nextTryAttempt)

                                var lastcontact = currentScope.exchange[t].lastContact.toString();
                                var lastcontactyear = lastcontact.substring(0, 4); var lastcontactmonth = lastcontact.substring(5, 7); var lastcontactday = lastcontact.substring(8, 10);

                                var nextattempt = currentScope.exchange[t].nextTryAttempt.toString();
                                var nextattemptyear = nextattempt.substring(0, 4); var nextattemptmonth = nextattempt.substring(5, 7); var nextattemptday = nextattempt.substring(8, 10);

                                var lastattempt = currentScope.exchange[t].lastTryAttempt.toString();
                                var lastattemptyear = lastattempt.substring(0, 4); var lastattemptmonth = lastattempt.substring(5, 7); var lastattemptday = lastattempt.substring(8, 10);

                                document.getElementById("conCom").innerHTML = currentScope.exchange[t].contact.customer.name;
                                document.getElementById("conMail").innerHTML = currentScope.exchange[t].contact.addressInfo.email;
                                document.getElementById("conPhone").innerHTML = currentScope.exchange[t].contact.addressInfo.phone;
                                document.getElementById("conAddr").innerHTML = currentScope.exchange[t].contact.addressInfo.address;
                                document.getElementById("conNextAtt").innerHTML = nextcontactday + "/" + nextcontactmonth + "/" + nextcontactyear;
                                document.getElementById("conLastAtt").innerHTML = lastcontactday + "/" + lastcontactmonth + "/" + lastcontactyear;
                                document.getElementById("conNextTry").innerHTML = nextattemptday + "/" + nextattemptmonth + "/" + nextattemptyear;
                                document.getElementById("conLastTry").innerHTML = lastattemptday + "/" + lastattemptmonth + "/" + lastattemptyear;
                                document.getElementById("contactInfomation").style.display = 'block';

                                if (Date.now() > trydate) {
                                    document.getElementById("conNextAtt").style.color = 'red';
                                }
                                if (Date.now() > attemptdate) {
                                    document.getElementById("conNextTry").style.color = 'red';
                                }
                            }
                        }
                    }
                });

            });


            $("#MailBtn").on("click", function () {
                if (document.getElementById("mailDiv").style.display == 'block')
                    document.getElementById("mailDiv").style.display = 'none';
                else
                    document.getElementById("mailDiv").style.display = 'block';
                document.getElementById("phoneDiv").style.display = 'none';
            });

            $("#sendMailBtn").on("click", function () {
                //window.open("mailto:" + currentContact.addressInfo.email + "?subject=" + document.getElementById('MailHeader').innerHTML);
                var subject = $('#MailHeader').val();
                var body = $('#MailBody').val();
                var mail = 'mailto:' + currentContact.addressInfo.email + '?subject='+subject+'&body='+body;

                $('<iframe src="' + mail + '">').appendTo('body').css("display", "none");

                document.getElementById("mailDiv").style.display = 'none';
                document.getElementById("phoneDiv").style.display = 'block';
            });

            $("#PhoneBtn").on("click", function () {
                if (document.getElementById("phoneDiv").style.display == 'block')
                    document.getElementById("phoneDiv").style.display = 'none';
                else
                    document.getElementById("phoneDiv").style.display = 'block';
                document.getElementById("mailDiv").style.display = 'none';
            });
            $("#yesBtn").on("click", function () {
                for (var t = 0; t < currentScope.exchange.length; t++) {
                    if (currentScope.exchange[t].userId == currentUser.id && currentScope.exchange[t].contactId == currentContact.id) {
                        newExchange = currentScope.exchange[t];

                        newExchange.contact = currentContact;
                        newExchange.user = currentUser;

                        newExchange.priority = 3;

                        $.ajax({
                            url: "/api/exchanges",
                            method: "PUT",
                            data: newExchange
                        })

                        setTimeout(function () { window.location.reload(); }, 200);
                    }
                }

            });
            $("#noBtn").on("click", function () {
                for (var t = 0; t < currentScope.exchange.length; t++) {
                    if (currentScope.exchange[t].userId == currentUser.id && currentScope.exchange[t].contactId == currentContact.id) {
                        newExchange = currentScope.exchange[t];

                        newExchange.contact = currentContact;
                        newExchange.user = currentUser;

                        var date = new Date();
                        date.setDate(date.getDate() + 2);

                        var trydate = Date.parse(currentScope.exchange[t].nextContact);

                        if (trydate > date)
                            newExchange.priority = 2;
                        else
                            newExchange.priority = 1;


                        $.ajax({
                            url: "/api/exchanges",
                            method: "PUT",
                            data: newExchange
                        })

                        setTimeout(function () { window.location.reload(); }, 200);
                    }
                }

            });

            $("#createCustomer").on("click", function () {
                document.getElementById("contactInfomation").style.display = 'none';
                document.getElementById("mailDiv").style.display = 'none';
                document.getElementById("phoneDiv").style.display = 'none';
                document.getElementById("createInformation").style.display = 'block';
                document.getElementById("createTypeName").innerHTML = "Create Customer";

                document.getElementById("creatingContact").style.display = 'none';
                document.getElementById("creatingCompany").style.display = 'none';
                document.getElementById("creatingCustomer").style.display = 'block';
                document.getElementById("allConts").style.display = 'none';
            });
            $("#createContact").on("click", function () {
                document.getElementById("contactInfomation").style.display = 'none';
                document.getElementById("mailDiv").style.display = 'none';
                document.getElementById("phoneDiv").style.display = 'none';
                document.getElementById("createInformation").style.display = 'block';
                document.getElementById("createTypeName").innerHTML = "Create Contact";

                document.getElementById("creatingContact").style.display = 'block';
                document.getElementById("creatingCompany").style.display = 'none';
                document.getElementById("creatingCustomer").style.display = 'none';
            });
            $("#createCompany").on("click", function () {
                document.getElementById("contactInfomation").style.display = 'none';
                document.getElementById("mailDiv").style.display = 'none';
                document.getElementById("phoneDiv").style.display = 'none';
                document.getElementById("createInformation").style.display = 'block';
                document.getElementById("createTypeName").innerHTML = "Create Company";

                document.getElementById("creatingContact").style.display = 'none';
                document.getElementById("creatingCompany").style.display = 'block';
                document.getElementById("creatingCustomer").style.display = 'none';
                document.getElementById("allConts").style.display = 'none';
            });

            $("#createCustomerBtn").on("click", function () {
                var errors = 0;

                if ($('#CustomerName').val() == "") {document.getElementById("creatingCustomerNameError").innerHTML = "Name is required";errors++;
                }
                else
                    document.getElementById("creatingCustomerNameError").innerHTML = "";

                if ($('#CustomerEmail').val() == "") {document.getElementById("creatingCustomerMailError").innerHTML = "ERROR"; errors++;}
                else if (!(/^\w+([\.-]?\w+)*@@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test($('#CustomerEmail').val()))) {document.getElementById("creatingCustomerMailError").innerHTML = "Invalid email"; errors++;}
                else
                    document.getElementById("creatingCustomerMailError").innerHTML = "";

                if ($('#CustomerAddress').val() == "") {document.getElementById("creatingCustomerAddressError").innerHTML = "Address is required"; errors++;}
                else
                    document.getElementById("creatingCustomerAddressError").innerHTML = "";

                if ($('#CustomerPhone').val() == "") {document.getElementById("creatingCustomerPhoneError").innerHTML = "Phone is Required"; errors++;}
                else if (isNaN($('#CustomerPhone').val())) {document.getElementById("creatingCustomerPhoneError").innerHTML = "Only digits"; errors++;}
                else if ($('#CustomerPhone').val().length != 8) {document.getElementById("creatingCustomerPhoneError").innerHTML = "Phone is 8 digits"; errors++;}
                else
                    document.getElementById("creatingCustomerPhoneError").innerHTML = "";

                if (errors != 0)
                    return;
                
                var newCustomer = {
                    id: "",
                    name: "",
                    addressInfoId: "",
                    addressInfo: {
                        id: "",
                        address: "",
                        email: "",
                        phone: ""
                    }
                };

                newCustomer.name = $('#CustomerName').val();
                newCustomer.id = currentScope.companyCustomer[0].companyId;
                newCustomer.addressInfo.address = $('#CustomerAddress').val();
                newCustomer.addressInfo.phone = $('#CustomerPhone').val();
                newCustomer.addressInfo.email = $('#CustomerEmail').val();

                console.log("NewCustomer");
                console.log(newCustomer);

                $.ajax({
                    url: "/api/customers",
                    method: "Post",
                    data: newCustomer
                })

                setTimeout(function () { window.location.reload(); }, 200);
            });

            $("#createCompanyBtn").on("click", function () {
                var errors = 0;

                if ($('#CompanyName').val() == "") {document.getElementById("creatingCompanyNameError").innerHTML = "Name is required";errors++;}
                else
                    document.getElementById("creatingCompanyNameError").innerHTML = "";

                if ($('#CompanyEmail').val() == "") {document.getElementById("creatingCompanyMailError").innerHTML = "ERROR"; errors++;}
                else if (!(/^\w+([\.-]?\w+)*@@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test($('#CompanyEmail').val()))) {document.getElementById("creatingCompanyMailError").innerHTML = "Invalid email"; errors++;}
                else
                    document.getElementById("creatingCompanyMailError").innerHTML = "";

                if ($('#CompanyAddress').val() == "") {document.getElementById("creatingCompanyAddressError").innerHTML = "Address is required"; errors++;}
                else
                    document.getElementById("creatingCompanyAddressError").innerHTML = "";

                if ($('#CompanyPhone').val() == "") {document.getElementById("creatingCompanyPhoneError").innerHTML = "Phone is Required"; errors++;}
                else if (isNaN($('#CompanyPhone').val())) {document.getElementById("creatingCompanyPhoneError").innerHTML = "Only digits"; errors++;}
                else if ($('#CompanyPhone').val().length != 8) {document.getElementById("creatingCompanyPhoneError").innerHTML = "Phone is 8 digits"; errors++;}
                else
                    document.getElementById("creatingCompanyPhoneError").innerHTML = "";
                
                if (errors != 0)
                    return;
                
                var newCompany = {
                    id: "",
                    name: "",
                    addressInfoId: "",
                    addressInfo: {
                        id: "",
                        address: "",
                        email: "",
                        phone: ""
                    }
                };

                newCompany.name = $('#CompanyName').val();
                newCompany.addressInfo.address = $('#CompanyAddress').val();
                newCompany.addressInfo.phone = $('#CompanyPhone').val();
                newCompany.addressInfo.email = $('#CompanyEmail').val();

                console.log("NewCompany");
                console.log(newCompany);

                $.ajax({
                    url: "/api/companies",
                    method: "Post",
                    data: newCompany
                })

                setTimeout(function () { window.location.reload(); }, 200);
            });

            $("#createContactBtn").on("click", function () {
                var errors = 0;

                if ($('#ContactName').val() == "") { document.getElementById("creatingContactNameError").innerHTML = "Name is required"; errors++; }
                else
                    document.getElementById("creatingContactNameError").innerHTML = "";

                if ($('#ContactEmail').val() == "") { document.getElementById("creatingContactMailError").innerHTML = "ERROR"; errors++; }
                else if (!(/^\w+([\.-]?\w+)*@@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test($('#ContactEmail').val()))) { document.getElementById("creatingContactMailError").innerHTML = "Invalid email"; errors++; }
                else
                    document.getElementById("creatingContactMailError").innerHTML = "";

                if ($('#ContactAddress').val() == "") { document.getElementById("creatingContactAddressError").innerHTML = "Address is required"; errors++; }
                else
                    document.getElementById("creatingContactAddressError").innerHTML = "";

                if ($('#ContactPhone').val() == "") { document.getElementById("creatingContactPhoneError").innerHTML = "Phone is Required"; errors++; }
                else if (isNaN($('#ContactPhone').val())) { document.getElementById("creatingContactPhoneError").innerHTML = "Only digits"; errors++; }
                else if ($('#ContactPhone').val().length != 8) { document.getElementById("creatingContactPhoneError").innerHTML = "Phone is 8 digits"; errors++; }
                else
                    document.getElementById("creatingContactPhoneError").innerHTML = "";

                if (document.getElementById("ContactFreqeuncy").value == "") { document.getElementById("creatingContactFrequencyError").innerHTML = "Frequency is required"; errors++; }
                else if (document.getElementById("ContactFreqeuncy").value < 1) { document.getElementById("creatingContactFrequencyError").innerHTML = "Frequency can't be lower than 1"; errors++; }
                else if (document.getElementById("ContactFreqeuncy").value > 365) { document.getElementById("creatingContactFrequencyError").innerHTML = "Frequency can't be higher than 365"; errors++; }
                else
                    document.getElementById("creatingContactFrequencyError").innerHTML = "";

                if (errors != 0)
                    return;

                var newContact = {
                    id: "",
                    name: "",
                    customerId:"",
                    addressInfoId: "",
                    addressInfo: {
                        id: "",
                        address: "",
                        email: "",
                        phone: ""
                    }
                };

                var newExchange = {
                    priority: 3,
                    companyCustomerId: "",
                    userId: currentUser.id,
                    contactId: "",
                    frequency: document.getElementById("ContactFreqeuncy").value
                };
                
                newContact.name = $('#ContactName').val();
                newContact.customerId = currentCustomer;
                newContact.addressInfo.address = $('#ContactAddress').val();
                newContact.addressInfo.phone = $('#ContactPhone').val();
                newContact.addressInfo.email = $('#ContactEmail').val();

                console.log("NewContact");
                console.log(newContact);

                var currentCompId = currentScope.companyCustomer[0].companyId

                $.ajax({
                    url: "/api/contacts",
                    method: "Post",
                    data: newContact,
                    success: function (response) {
                        console.log(response.id);
                        for (var q = 0; q < currentScope.companyCustomer.length; q++) {
                            if (currentScope.companyCustomer[q].companyId == currentCompId && currentScope.companyCustomer[q].customerId == currentCustomer) {
                                console.log(response);
                                newExchange.contactId = response.id;
                                newExchange.companyCustomerId = currentScope.companyCustomer[q].id;
                                $.ajax({
                                    url: "/api/exchanges",
                                    method: "Post",
                                    data: newExchange,
                                })
                            }
                        }
                    }
                })
                
                setTimeout(function () { window.location.reload(); }, 200);
            });

        })
    </script>
}
